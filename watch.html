<!doctype html>
<html lang="en">
<head>…</head>
<body>
  <h1 id="film-title">Loading…</h1>
  <div id="description"></div>
  <div id="buttons"></div>
  <div id="player">After renting, your film will appear here.</div>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
  (async()=>{
    const api       = 'https://sanrokuku.com/wp-json/film/v1';
    const p         = new URLSearchParams(location.search);
    const slug      = p.get('slug');
    const sessionId = p.get('session_id');
    if(!slug) return document.body.innerText='No film specified.';

    // 1) metadata
    const md = await fetch(`${api}/film-data?slug=${slug}`);
    const film = await md.json();
    document.getElementById('film-title').innerText = film.title;
    document.getElementById('description').innerHTML = film.description;

    const btns = document.getElementById('buttons');
    // 2) not rented?
    if (!sessionId) {
      btns.innerHTML = `<a class="btn" href="https://sanrokuku.com/movie/${slug}/">→ Rent this film on Sanrokuku.com</a>`;
      return;
    }
    // 3) rented → get token & play
    try {
      const r = await fetch(`${api}/token`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({session_id:sessionId})
      });
      const {url} = await r.json();
      const c = document.getElementById('player');
      c.innerHTML = `<video controls crossorigin="anonymous" style="max-width:100%;">
        <source src="${url}" type="application/vnd.apple.mpegurl">
      </video>`;
    } catch(e) {
      console.error(e);
      document.getElementById('player').innerText='Unable to load video.';
    }
  })();
  </script>
</body>
</html>
