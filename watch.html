<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Watch Film</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body { font-family:sans-serif; max-width:720px; margin:2rem auto; padding:0 1rem }
    button.rent-now {
      background:#0073aa; color:#fff; border:none;
      border-radius:.25rem; padding:.75rem 1.5rem;
      font-size:1rem; cursor:pointer;
    }
  </style>
</head>
<body>
  <h1 id="film-title">Loading…</h1>
  <div id="description"></div>
  <div id="buttons"></div>
  <div id="player">After renting, your film will appear here.</div>

  <script>
  (async()=>{
    const params    = new URLSearchParams(location.search);
    const slug      = params.get('slug');
    const apiOrigin = 'https://sanrokuku.com/wp-json/film/v1';

    if (!slug) {
      return document.body.innerText = 'No film specified.';
    }

    // Fetch film info
    let film;
    try {
      const r = await fetch(`${apiOrigin}/film-data?slug=${slug}`);
      film = await r.json();
      if (film.code) throw film;
    } catch(e) {
      console.error(e);
      return document.getElementById('film-title').innerText = 'Error loading film.';
    }

    // Show title/desc
    document.getElementById('film-title').innerText   = film.title;
    document.getElementById('description').innerHTML = film.description;

    // Rent button
    const btn = document.createElement('button');
    btn.className = 'rent-now';
    btn.innerText = `Rent $${(film.rent_price/100).toFixed(2)}`;
    btn.onclick   = async () => {
      // Create session
      let data;
      try {
        const res = await fetch(`${apiOrigin}/checkout`, {
          method:      'POST',
          credentials: 'include',
          headers:     {'Content-Type':'application/json'},
          body:        JSON.stringify({slug})
        });
        if (!res.ok) throw await res.json();
        data = await res.json();
      } catch(err) {
        console.error(err);
        return alert('Checkout creation failed; see console.');
      }
      console.log('Stripe sessionId:', data.sessionId);
      // Redirect to hosted Checkout
      window.location.href = `https://checkout.stripe.com/pay/${data.sessionId}`;
    };
    document.getElementById('buttons').appendChild(btn);
  })();
  </script>
</body>
</html>
