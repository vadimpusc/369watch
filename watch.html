<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Watch Film</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body { font-family: sans-serif; max-width: 720px; margin: 2rem auto; padding: 0 1rem; }
    h1   { font-size: 2rem; margin-bottom: .5rem; }
    #description { margin-bottom: 1.5rem; }
    .btn { 
      display: inline-block; 
      padding: .75rem 1.5rem; 
      background: #0073aa; 
      color: #fff; 
      text-decoration: none; 
      border-radius: .25rem;
      font-size: 1rem;
    }
    #player { margin-top: 2rem; }
  </style>
</head>
<body>
  <h1 id="film-title">Loading…</h1>
  <div id="description"></div>
  <div id="buttons"></div>
  <div id="player">After renting, your film will appear here.</div>

  <script>
  // ← wrap everything in DOMContentLoaded so all IDs exist
  document.addEventListener('DOMContentLoaded', async function(){
    const API_ORIGIN = 'https://sanrokuku.com/wp-json/film/v1';
    const params     = new URLSearchParams(location.search);
    const slug       = params.get('slug');
    const sessionId  = params.get('session_id');

    if (!slug) {
      document.body.innerText = 'No film specified.';
      return;
    }

    // 1) fetch metadata
    let film;
    try {
      const res = await fetch(`${API_ORIGIN}/film-data?slug=${slug}`);
      film = await res.json();
      if (film.code) throw film;
    } catch {
      document.getElementById('film-title').innerText = 'Error loading film info.';
      return;
    }

    // 2) render title & description
    document.getElementById('film-title').innerText   = film.title;
    document.getElementById('description').innerHTML = film.description;

    const buttons = document.getElementById('buttons');

    // 3) if no session → link to /rent?slug=
    if (!sessionId) {
      buttons.innerHTML = `
        <a class="btn" href="https://sanrokuku.com/rent?slug=${encodeURIComponent(slug)}">
          → Rent this film on Sanrokuku.com
        </a>`;
      return;
    }

    // 4) otherwise fetch Bunny token & play
    try {
      const tokenRes = await fetch(`${API_ORIGIN}/token`, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ session_id: sessionId })
      });
      if (!tokenRes.ok) throw await tokenRes.json();
      const { url } = await tokenRes.json();
      renderPlayer(url);
    } catch (err) {
      console.error(err);
      document.getElementById('player').innerText = 'Unable to load video.';
    }

    // 5) HLS.js player
    function renderPlayer(hlsUrl) {
      const container = document.getElementById('player');
      container.innerHTML = '';
      if (window.Hls && Hls.isSupported()) {
        const video = document.createElement('video');
        video.controls     = true;
        video.crossOrigin  = 'anonymous';
        video.style.maxWidth = '100%';
        container.appendChild(video);
        const hls = new Hls();
        hls.loadSource(hlsUrl);
        hls.attachMedia(video);
      } else {
        container.innerHTML = `
          <video controls crossorigin="anonymous" style="max-width:100%">
            <source src="${hlsUrl}" type="application/vnd.apple.mpegurl">
            Your browser doesn’t support HLS.
          </video>`;
      }
    }
  });
  </script>
</body>
</html>
