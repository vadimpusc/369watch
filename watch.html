<!doctype html><html><head>
  <meta charset="utf-8"><title>Watch Film</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>/* your CSS */</style>
</head><body>
  <h1 id="film-title">Loading…</h1>
  <div id="description"></div>
  <div id="buttons"></div>
  <div id="player">After renting, your film will appear here.</div>
  <script>
  (async()=>{
    const params = new URLSearchParams(location.search);
    const slug   = params.get('slug');
    const session_id = params.get('session_id');
    const apiOrigin = 'https://sanrokuku.com/wp-json/film/v1';

    if(!slug) {
      document.body.innerText = 'No film specified.';
      return;
    }

    // 1) Fetch metadata
    let film;
    try {
      const r = await fetch(`${apiOrigin}/film-data?slug=${slug}`);
      film = await r.json();
      if(film.code) throw film;
    } catch(err) {
      document.getElementById('film-title').innerText = 'Error loading film info.';
      return;
    }

    // 2) Render title & desc
    document.getElementById('film-title').innerText = film.title;
    document.getElementById('description').innerHTML = film.description;

    // 3) Render Rent button
    const btn = document.createElement('button');
    btn.innerText = `Rent $${(film.rent_price/100).toFixed(2)}`;
    btn.onclick = ()=> startCheckout(slug);
    document.getElementById('buttons').appendChild(btn);

    // 4) Start Stripe Checkout
    async function startCheckout(slug) {
      const res = await fetch(`${apiOrigin}/checkout`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({slug})
      });
      const { sessionId } = await res.json();
      window.location = `https://checkout.stripe.com/pay/${sessionId}`;
    }

    // 5) On return, fetch Bunny token
    if(session_id) {
      try {
        const r = await fetch(`${apiOrigin}/token`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({session_id})
        });
        const { url } = await r.json();
        renderPlayer(url);
      } catch(e) {
        document.getElementById('player').innerText = 'Unable to load video.';
      }
    }

    // 6) HLS.js player
    function renderPlayer(hlsUrl) {
      const c = document.getElementById('player');
      c.innerHTML = '';
      if(window.Hls && Hls.isSupported()){
        const v = document.createElement('video');
        v.controls=true; v.style.maxWidth='100%';
        c.appendChild(v);
        const hls = new Hls(); hls.loadSource(hlsUrl); hls.attachMedia(v);
      } else {
        c.innerHTML = `<video controls style="max-width:100%">
          <source src="${hlsUrl}" type="application/vnd.apple.mpegurl">
          Your browser doesn’t support HLS.
        </video>`;
      }
    }
  })();
  </script>
</body></html>
