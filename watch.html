<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Watch Film</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body { font-family:sans-serif; max-width:720px; margin:2rem auto; padding:0 1rem; }
    #buttons { margin:1.5rem 0; }
    .rent-now {
      background:#0073aa; color:#fff; border:none;
      border-radius:.25rem; padding:.75rem 1.5rem;
      font-size:1rem; cursor:pointer;
    }
  </style>
</head>
<body>
  <h1 id="film-title">Loading…</h1>
  <div id="description"></div>
  <div id="buttons"></div>
  <div id="player">After renting, your film will appear here.</div>

  <script>
  (async()=>{
    const params    = new URLSearchParams(location.search);
    const slug      = params.get('slug');
    const session_id= params.get('session_id');
    const apiOrigin = 'https://sanrokuku.com/wp-json/film/v1';
    const loginUrl  = 'https://sanrokuku.com/poko?redirect_to=' + encodeURIComponent(location.href);

    if (!slug) {
      return document.body.innerText = 'No film specified.';
    }

    // 0) Check login status via WP REST
    let loggedIn = false;
    try {
      const me = await fetch('https://sanrokuku.com/wp-json/wp/v2/users/me', { credentials:'include' });
      if (me.ok) loggedIn = true;
    } catch(e){
      console.warn('Login check failed',e);
    }

    // 1) Fetch film metadata
    let film;
    try {
      const r = await fetch(`${apiOrigin}/film-data?slug=${slug}`);
      film = await r.json();
      if (film.code) throw film;
    } catch (err) {
      console.error('film-data error',err);
      document.getElementById('film-title').innerText='Error loading film.';
      return;
    }

    // 2) Render title & description
    document.getElementById('film-title').innerText   = film.title;
    document.getElementById('description').innerHTML = film.description;

    // 3) Show login prompt or rent button
    const buttons = document.getElementById('buttons');
    if (!loggedIn) {
      buttons.innerHTML = `<a class="rent-now" href="${loginUrl}">Log in to rent</a>`;
      return;
    }

    // 4) Render Rent button
    const btn = document.createElement('button');
    btn.className = 'rent-now';
    btn.innerText = `Rent $${(film.rent_price/100).toFixed(2)}`;
    btn.onclick   = ()=> startCheckout(slug);
    buttons.appendChild(btn);

    // 5) startCheckout → /checkout → redirect to full session.url
    async function startCheckout(slug) {
      try {
        const res = await fetch(`${apiOrigin}/checkout`, {
          method:'POST',
          credentials:'include',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({slug})
        });
        if (res.status === 403) {
          window.location = loginUrl;
          return;
        }
        if (!res.ok) throw await res.json();
        const { url } = await res.json();
        window.location.href = url;
      } catch(err) {
        console.error('startCheckout error',err);
        alert('Error starting checkout; see console.');
      }
    }

    // 6) After return, fetch Bunny token & play
    if (session_id) {
      try {
        const r = await fetch(`${apiOrigin}/token`, {
          method:'POST',
          credentials:'include',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({session_id})
        });
        if (r.status===403) {
          window.location = loginUrl;
          return;
        }
        if (!r.ok) throw await r.json();
        const { url } = await r.json();
        renderPlayer(url);
      } catch(e) {
        console.error('token error',e);
        document.getElementById('player').innerText='Unable to load video.';
      }
    }

    // 7) HLS.js player
    function renderPlayer(hlsUrl) {
      const c = document.getElementById('player');
      c.innerHTML = '';
      if (window.Hls && Hls.isSupported()) {
        const v = document.createElement('video');
        v.controls = true; v.crossOrigin = 'anonymous'; v.style.maxWidth='100%';
        c.appendChild(v);
        const hls = new Hls();
        hls.loadSource(hlsUrl);
        hls.attachMedia(v);
      } else {
        c.innerHTML = `<video controls crossOrigin="anonymous" style="max-width:100%">
          <source src="${hlsUrl}" type="application/vnd.apple.mpegurl">
          Your browser doesn’t support HLS.
        </video>`;
      }
    }
  })();
  </script>
</body>
</html>
